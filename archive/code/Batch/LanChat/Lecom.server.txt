:server
if "%param%"=="log" goto :server.logstart
set log=call :server.log
set server.name=The Debug Room
set server.ping.freq=200000
set server.ping.timeout=2000

for /d %%a in ("%data%\users\*.user") do (
call :server.readuser %%~na
)
:clearserver
for /d %%f in ("%public%\*") do (
del /q %%f
rd %%f)
del /q "%public%"
call :closed server.log


:server.consoleloop
set /p meeple=
goto :server.consoleloop


:server.logstart

if not exist "%data%\server.log" (echo Server log for %server.name%>"%data%\server.log")
%log% Server started

set lasttick=%time%
call :gettime %lasttick%


:servloop
call :servtick
call :serv.checkres
goto :servloop

:servtick

for %%f in ("%public%\*.*") do (
call :testfile %%~nf.%%~xf
)
set time=%time%
set tick=%time%
call :gettime tick
call :subtracttime tick lasttick
set tick=%tick.msec%
set lasttick=%time%
call :gettime lasttick
set time=
goto :eof

:serv.checknext
set /a since=since+tick
if /i %since% geq %server.ping.freq% (goto :serv.sendping)
goto :eof

:serv.sendping
set since=0
set tocheck=-1
for /f "tokens=1* delims==" %%f in ('set check[') do (call :serv.sendping.send %%g)
if "%tocheck%"=="-1" set tocheck=
goto :eof

:serv.sendping.send
set /a tocheck=tocheck+1
set tag=%random%
echo.>"%public%\trans.%*\%tag%.ping"
set ping.%tocheck%=%public%\trans.%*\%tag%.pong
set ping.%tocheck%.user=%*
goto :eof

:serv.checkres
if "%tocheck%"=="" goto :serv.checknext
for /l %%n in (0,1,%tocheck%) do (
call :serv.checkres.check %%n)
set /a since=since+tick
if /i %since% lss %server.ping.timeout% (goto :eof)
rem kill those who didn't respond here, 
rem and clean out associated variables
for /l %%n in (0,1,%tocheck%) do (
call :serv.checkres.kill %%n)
goto :eof

:serv.checkres.check
call :set file=%%ping.%*%%
if "%file%"=="" goto :eof
if exist "%file%" (del "%file%"
set ping.%*=
set ping.%*.user=)
goto :eof

:serv.checkres.kill
call :set cuser=%%ping.%*.user%%
if "%cuser%"=="" goto :eof
call :serv.cleanuser %cuser%
call :set check[%%user[%cuser%]%%]=
set user[%cuser%]=
set ping.%*=
set ping.%*.user=
%log% User %cuser% has timed out.
goto :eof

:serv.cleanuser
del /q %public%\trans.%*\*
rd %public%\trans.%*
goto :eof

:testfile
for /f "tokens=1* delims=." %%f in ("%*") do (
set tag=%%f
set ext=%%g
)
if "%ext%"=="lin" (goto :testfile.lin)
if "%ext%"=="sping" (goto :testfile.sping)
goto :eof

:testfile.sping
call :readfile message=%public%\%tag%.sping
%log% ~%message%
set message=
echo %server.name%>"%public%\%tag%.spong"
goto :eof

:testfile.lin
call :readfile user=%public%\%tag%.lin
for /f "tokens=1,2* delims=%#break#%" %%f in ("%user%") do (
set user=%%f
set pass=%%g
set junk=%%h
)
call :server.testuser
set user=
set pass=
set junk=
goto :eof

:server.testuser
set error=
call :set apass=%%username.pass[%user%]%%
if "%apass%"=="" (set error=1
goto :server.register)
if "%pass%"=="%apass%" goto :server.login
call :writefile %public%\%tag%.lnr/failed
%log% Failed attempt to log in as %user% via %pass%
goto :eof

:server.register
md "%data%\users\%user%.user"
echo %pass%>"%data%\users\%user%.user\pass.db"
call :server.log User %user% registered.
goto :server.login

:server.login
call :set check=%%user[%user%]%%
if not "%check%"=="" goto :server.login.double
set check=%random%
set user[%user%]=%check%
set check[%check%]=%user%
md "%public%\trans.%user%"
call :writefile %public%\%tag%.lnr/%check%%#break#%%error%
%log% User %user% logged in succesfully at %check%
set check=
goto :eof

:server.login.double
call :writefile %public%\%tag%.lnr/double
%log% Failed double login as %user% while already under %check%
set check=
goto :eof

:server.readuser
set /p username.pass[%*]=<"%data%\users\%*.user\pass.db"
goto :eof

:server.log
echo [%date% %time%] %*
echo [%date% %time%] %*>>"%data%\server.log"
goto :eof

